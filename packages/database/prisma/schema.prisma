datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

enum TransactionType {
  CREDIT
  DEBIT
}

enum TransactionSource {
  BUYBACK
  SALE
  PACK_PURCHASE
  REDEMPTION
  ADJUSTMENT
}

enum ItemStatus {
  STORED
  LISTED
  SOLD
  REDEEMED
  IN_TRANSFER
}

enum ListingStatus {
  ACTIVE
  SOLD
  REMOVED
}

enum PackStatus {
  UNOPENED
  OPENED
  REDEEMED
}

enum PackFulfillmentStatus {
  ONLINE
  READY_FOR_PACKING
  PACKED
  LOADED
}

enum QrCodeType {
  CARD
  PACK
}

enum QrCodeState {
  AVAILABLE
  RESERVED
  BOUND
  RETIRED
}

enum KioskClaimStatus {
  UNCLAIMED
  CLAIMED
  SOLD_BACK
}

enum IngestionStatus {
  PENDING
  REVIEW
  APPROVED
  REJECTED
}

enum CardAssetStatus {
  UPLOADING
  UPLOADED
  OCR_PENDING
  OCR_COMPLETE
  CLASSIFY_PENDING
  CLASSIFIED
  VALUATION_PENDING
  READY
  ASSIGNED
  ERROR
}

enum CardReviewStage {
  BYTEBOT_RUNNING
  READY_FOR_HUMAN_REVIEW
  ESCALATED_REVIEW
  REVIEW_COMPLETE
  INVENTORY_READY_FOR_SALE
}

enum CardEvidenceKind {
  SEARCH_PAGE
  SOLD_COMP
  MARKET_COMP
}

enum CardPhotoKind {
  FRONT
  BACK
  TILT
  CLOSEUP_SERIAL
  CLOSEUP_CARD_NUMBER
  CLOSEUP_LOGO_TEXT
  CLOSEUP_FOIL_STAMP
  AUTOGRAPH
  PATCH
  OTHER
}

enum ProcessingJobType {
  PHOTOROOM
  OCR
  CLASSIFY
  VALUATION
}

enum ProcessingJobStatus {
  QUEUED
  IN_PROGRESS
  COMPLETE
  FAILED
}

enum BytebotLiteJobStatus {
  QUEUED
  IN_PROGRESS
  COMPLETE
  FAILED
}

enum CollectibleCategory {
  SPORTS
  POKEMON
  COMICS
}

enum PackTier {
  TIER_25
  TIER_50
  TIER_100
  TIER_500
}

enum BatchStage {
  INVENTORY_READY
  PACKING
  PACKED
  SHIPPING_READY
  SHIPPING_SHIPPED
  SHIPPING_RECEIVED
  LOADED
}

enum ShippingStatus {
  PENDING
  IN_PROGRESS
  SHIPPED
  CANCELLED
}

enum PackLabelStatus {
  RESERVED
  PRINTED
  BOUND
}

enum KioskSessionStatus {
  COUNTDOWN
  LIVE
  REVEAL
  COMPLETE
  CANCELLED
}

model User {
  id              String          @id @default(uuid())
  email           String?         @unique
  phone           String?         @unique
  phoneVerifiedAt DateTime?
  displayName     String?
  avatarUrl       String?
  createdAt       DateTime        @default(now())
  wallet          Wallet?
  items           Item[]
  ownerships      ItemOwnership[]
  listings        Listing[]       @relation("SellerListings")
  shippingRequests ShippingRequest[]
  packs           PackInstance[]
  packedPacks     PackInstance[]  @relation("PackedByUser")
  loadedPacks     PackInstance[]  @relation("LoadedByUser")
  ingestions      IngestionTask[]
  cardBatches     CardBatch[]
  cardNotes       CardNote[]
  reviewedCards   CardAsset[]     @relation("CardAssetHumanReviewer")
  createdEvidenceItems CardEvidenceItem[] @relation("CardEvidenceCreatedBy")
  createdPhotos        CardPhoto[]        @relation("CardPhotoCreatedBy")
  inventoryBatchesCreated InventoryBatch[] @relation("InventoryBatchCreatedBy")
  bytebotPlaybookRules BytebotPlaybookRule[]
  sessions        Session[]
  qrCodesCreated  QrCode[]        @relation("QrCodeCreatedBy")
  qrCodesBound    QrCode[]        @relation("QrCodeBoundBy")
  kioskClaims     KioskSession[]  @relation("KioskClaimedBy")
  batchStageEvents BatchStageEvent[]
  locationRestocks LocationRestock[]
}

model Location {
  id          String   @id @default(uuid())
  slug        String   @unique
  name        String
  description String?
  address     String
  mapsUrl     String?
  mediaUrl    String?
  recentRips  Json     @db.JsonB
  muxStreamId   String?
  muxStreamKey  String?
  muxPlaybackId String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  liveRips      LiveRip[]
  kioskSessions KioskSession[]
  packInstances PackInstance[]
  qrCodes      QrCode[]
  packLabels   PackLabel[]
  restocks     LocationRestock[]
  inventoryBatches InventoryBatch[]
}

model LiveRip {
  id           String    @id @default(uuid())
  slug         String    @unique
  title        String
  description  String?
  videoUrl     String
  thumbnailUrl String?
  locationId   String?
  featured     Boolean   @default(false)
  viewCount    Int?
  muxAssetId   String?
  muxPlaybackId String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  location     Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  kioskSessionId String?  @unique
  kioskSession   KioskSession? @relation("KioskSessionLiveRip", fields: [kioskSessionId], references: [id], onDelete: SetNull)
}

model Wallet {
  id           String              @id @default(uuid())
  userId       String              @unique
  balance      Int                 @default(0)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]
}

model WalletTransaction {
  id          String            @id @default(uuid())
  walletId    String
  amount      Int
  type        TransactionType
  source      TransactionSource
  note        String?
  referenceId String?
  createdAt   DateTime          @default(now())
  wallet      Wallet            @relation(fields: [walletId], references: [id], onDelete: Cascade)
}

model Item {
  id             String          @id @default(uuid())
  name           String
  set            String
  number         String?
  language       String?
  foil           Boolean         @default(false)
  estimatedValue Int?
  status         ItemStatus      @default(STORED)
  vaultLocation  String?
  imageUrl       String?
  thumbnailUrl   String?
  detailsJson    Json?
  ownerId        String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  owner          User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  listings       Listing?
  ownerships     ItemOwnership[]
  packSlots      PackSlot[]
  ingestionTask  IngestionTask?
  shippingRequest ShippingRequest?
  kioskReveals   KioskSession[]  @relation("KioskReveal")
  cardQrCodeId   String?         @unique
  cardQrCode     QrCode?         @relation("CardQrCode", fields: [cardQrCodeId], references: [id])
  packLabels     PackLabel[]
}

model AuthVerification {
  id        String   @id @default(uuid())
  phone     String   @unique
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ItemOwnership {
  id         String   @id @default(uuid())
  itemId     String
  ownerId    String
  note       String?
  acquiredAt DateTime @default(now())
  item       Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  owner      User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
}

model Listing {
  id        String        @id @default(uuid())
  itemId    String        @unique
  sellerId  String
  price     Int
  status    ListingStatus @default(ACTIVE)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  item      Item          @relation(fields: [itemId], references: [id], onDelete: Cascade)
  seller    User          @relation("SellerListings", fields: [sellerId], references: [id], onDelete: Cascade)
}

model ShippingRequest {
  id                String          @id @default(uuid())
  itemId            String          @unique
  userId            String
  status            ShippingStatus  @default(PENDING)
  recipientName     String
  addressLine1      String
  addressLine2      String?
  city              String
  state             String?
  postalCode        String
  country           String
  phone             String?
  email             String?
  processingFeeMinor Int
  shippingFeeMinor  Int
  totalFeeMinor     Int
  notes             String?
  trackingNumber    String?
  carrier           String?
  fulfilledAt       DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PackDefinition {
  id             String              @id @default(uuid())
  name           String
  description    String?
  price          Int
  inventoryCount Int                 @default(0)
  category       CollectibleCategory @default(SPORTS)
  tier           PackTier            @default(TIER_50)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  packs          PackInstance[]
  cardAssets     CardAsset[]
}

model PackInstance {
  id               String         @id @default(uuid())
  packDefinitionId String
  ownerId          String?
  status           PackStatus     @default(UNOPENED)
  fulfillmentStatus PackFulfillmentStatus @default(ONLINE)
  locationId       String?
  sourceBatchId    String?
  createdAt        DateTime       @default(now())
  openedAt         DateTime?
  packedAt         DateTime?
  packedById       String?
  loadedAt         DateTime?
  loadedById       String?
  packQrCodeId     String?        @unique
  packDefinition   PackDefinition @relation(fields: [packDefinitionId], references: [id], onDelete: Cascade)
  owner            User?          @relation(fields: [ownerId], references: [id])
  slots            PackSlot[]
  kioskSessions    KioskSession[]
  location         Location?      @relation(fields: [locationId], references: [id], onDelete: SetNull)
  packedBy         User?          @relation("PackedByUser", fields: [packedById], references: [id])
  loadedBy         User?          @relation("LoadedByUser", fields: [loadedById], references: [id])
  packQrCode       QrCode?        @relation("PackQrCode", fields: [packQrCodeId], references: [id])
  packLabels       PackLabel[]
  sourceBatch      CardBatch?     @relation("PackInstanceSourceBatch", fields: [sourceBatchId], references: [id], onDelete: SetNull)
}

model KioskSession {
  id                 String             @id @default(uuid())
  code               String             @unique
  controlTokenHash   String
  packInstanceId     String?
  locationId         String?
  packQrCodeId       String?
  packResetVersion   Int           @default(0)
  packQrCodeSerial   String?
  claimedById        String?
  claimStatus        KioskClaimStatus  @default(UNCLAIMED)
  status             KioskSessionStatus @default(COUNTDOWN)
  countdownSeconds   Int                @default(10)
  liveSeconds        Int                @default(30)
  revealSeconds      Int                @default(10)
  countdownStartedAt DateTime           @default(now())
  liveStartedAt      DateTime?
  revealStartedAt    DateTime?
  revealItemId       String?
  videoUrl           String?
  thumbnailUrl       String?
  qrLinkUrl          String?
  buybackLinkUrl     String?
  revealPayload      Json?
  muxStreamId        String?
  muxStreamKey       String?
  muxPlaybackId      String?
  muxAssetId         String?
  muxBroadcastId     String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  completedAt        DateTime?

  packInstance PackInstance? @relation(fields: [packInstanceId], references: [id], onDelete: SetNull)
  location     Location?     @relation(fields: [locationId], references: [id], onDelete: SetNull)
  revealItem   Item?         @relation("KioskReveal", fields: [revealItemId], references: [id], onDelete: SetNull)
  liveRip      LiveRip?        @relation("KioskSessionLiveRip")
  packQrCode   QrCode?       @relation("SessionPackQr", fields: [packQrCodeId], references: [id])
  claimedBy    User?         @relation("KioskClaimedBy", fields: [claimedById], references: [id])
}

model PackSlot {
  id             String       @id @default(uuid())
  packInstanceId String
  itemId         String
  packInstance   PackInstance @relation(fields: [packInstanceId], references: [id], onDelete: Cascade)
  item           Item         @relation(fields: [itemId], references: [id], onDelete: Cascade)
}

model IngestionTask {
  id         String          @id @default(uuid())
  externalId String?
  status     IngestionStatus @default(PENDING)
  itemId     String?         @unique
  ownerId    String
  rawPayload Json?
  notes      String?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  item       Item?           @relation(fields: [itemId], references: [id])
  owner      User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
}

model CardBatch {
  id             String   @id @default(uuid())
  label          String?
  notes          String?
  uploadedById   String
  totalCount     Int      @default(0)
  processedCount Int      @default(0)
  status         String   @default("UPLOADING")
  stage          BatchStage @default(INVENTORY_READY)
  tags           String[] @default([])
  stageChangedAt DateTime? @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  uploadedBy   User        @relation(fields: [uploadedById], references: [id], onDelete: Cascade)
  cards        CardAsset[]
  packLabels   PackLabel[]
  sourcePacks  PackInstance[] @relation("PackInstanceSourceBatch")
  stageEvents  BatchStageEvent[]
}

model BatchStageEvent {
  id        String      @id @default(uuid())
  batchId   String
  stage     BatchStage
  note      String?
  actorId   String?
  createdAt DateTime    @default(now())

  batch  CardBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  actor  User?      @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@index([batchId])
  @@index([stage])
}

model LocationRestock {
  id         String   @id @default(uuid())
  locationId String   @db.Uuid
  operatorId String?
  countsJson Json?
  photoUrl   String?
  notes      String?
  createdAt  DateTime @default(now())

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  operator User?    @relation(fields: [operatorId], references: [id], onDelete: SetNull)

  @@index([locationId])
  @@index([createdAt])
}

model CardAsset {
  id                      String          @id @default(uuid())
  batchId                 String
  storageKey              String
  fileName                String
  fileSize                Int
  mimeType                String
  imageUrl                String
  thumbnailUrl            String?
  status                  CardAssetStatus @default(UPLOADING)
  ocrText                 String?
  ocrJson                 Json?
  ocrSuggestionJson       Json?
  ocrSuggestionUpdatedAt  DateTime?
  backgroundRemovedAt     DateTime?
  patternSignatureJson    Json?
  patternSignatureUpdatedAt DateTime?
  classificationJson      Json?
  classificationSourcesJson Json?
  valuationMinor          Int?
  valuationCurrency       String?         @default("USD")
  valuationSource         String?
  marketplaceUrl          String?
  assignedDefinitionId    String?
  assignedAt              DateTime?
  errorMessage            String?
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  processingStartedAt     DateTime?
  processingCompletedAt   DateTime?
  customTitle             String?
  customDetails           String?
  ebaySoldUrl             String?
  ebaySoldUrlVariant      String?
  ebaySoldUrlHighGrade    String?
  ebaySoldUrlPlayerComp   String?
  ebaySoldUrlAiGrade      String?
  humanReviewedAt         DateTime?
  humanReviewedById       String?
  sportsDbPlayerId        String?
  sportsDbMatchConfidence Float?
  resolvedPlayerName      String?
  resolvedTeamName        String?
  playerStatsSnapshot     Json?
  aiGradingJson           Json?
  aiGradeFinal            Float?
  aiGradeLabel            String?
  aiGradePsaEquivalent    Int?
  aiGradeRangeLow         Int?
  aiGradeRangeHigh        Int?
  aiGradeGeneratedAt      DateTime?
  reviewStage             CardReviewStage?
  reviewStageUpdatedAt    DateTime?
  inventoryBatchId        String?
  inventoryAssignedAt     DateTime?
  variantId               String?
  variantConfidence       Float?

  batch              CardBatch       @relation(fields: [batchId], references: [id], onDelete: Cascade)
  assignedDefinition PackDefinition? @relation(fields: [assignedDefinitionId], references: [id], onDelete: SetNull)
  notes              CardNote[]
  jobs               ProcessingJob[]
  bytebotLiteJobs    BytebotLiteJob[]
  evidenceItems      CardEvidenceItem[]
  photos             CardPhoto[]
  inventoryBatch     InventoryBatch? @relation(fields: [inventoryBatchId], references: [id], onDelete: SetNull)
  humanReviewer      User?           @relation("CardAssetHumanReviewer", fields: [humanReviewedById], references: [id])
  sportsDbPlayer     SportsDbPlayer? @relation(fields: [sportsDbPlayerId], references: [id], onDelete: SetNull)
  variantDecisions   CardVariantDecision[]
  ocrFeedbackEvents  OcrFeedbackEvent[]

  @@index([sportsDbPlayerId])
  @@index([inventoryBatchId])
}

model CardVariant {
  id             String   @id @default(uuid())
  setId          String
  cardNumber     String
  parallelId     String
  parallelFamily String?
  keywords       String[] @default([])
  oddsInfo       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([setId, cardNumber])
  @@unique([setId, cardNumber, parallelId])
}

model CardVariantReferenceImage {
  id             String   @id @default(uuid())
  setId          String
  parallelId     String
  sourceUrl      String?
  listingTitle   String?
  rawImageUrl    String
  cropUrls       String[] @default([])
  cropEmbeddings Json?
  qualityScore   Float?
  qualityGateScore       Int?
  qualityGateStatus      String?
  qualityGateReasonsJson Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([setId, parallelId])
  @@index([setId, parallelId, qualityGateStatus])
}

model CardVariantDecision {
  id                 String   @id @default(uuid())
  cardAssetId        String
  candidatesJson     Json
  selectedParallelId String?
  confidence         Float?
  humanOverride      Boolean  @default(false)
  humanNotes         String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  cardAsset CardAsset @relation(fields: [cardAssetId], references: [id], onDelete: Cascade)

  @@index([cardAssetId])
}

model OcrFeedbackEvent {
  id            String   @id @default(uuid())
  cardAssetId   String
  fieldName     String
  modelValue    String?
  humanValue    String?
  wasCorrect    Boolean
  setId         String?
  year          String?
  manufacturer  String?
  sport         String?
  cardNumber    String?
  numbered      String?
  tokenRefsJson Json?
  modelVersion  String?
  createdAt     DateTime @default(now())

  cardAsset CardAsset @relation(fields: [cardAssetId], references: [id], onDelete: Cascade)

  @@index([cardAssetId, createdAt])
  @@index([fieldName, wasCorrect, createdAt])
  @@index([setId, year, manufacturer])
}

model InventoryBatch {
  id          String   @id @default(uuid())
  locationId  String   @db.Uuid
  label       String?
  notes       String?
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  location  Location  @relation(fields: [locationId], references: [id], onDelete: Cascade)
  createdBy User?     @relation("InventoryBatchCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  cards      CardAsset[]

  @@index([locationId])
  @@index([createdById])
}

model CardEvidenceItem {
  id            String           @id @default(uuid())
  cardAssetId   String
  kind          CardEvidenceKind @default(SOLD_COMP)
  source        String
  title         String?
  url           String
  screenshotUrl String?
  price         String?
  soldDate      String?
  note          String?
  createdById   String?
  createdAt     DateTime         @default(now())

  cardAsset CardAsset @relation(fields: [cardAssetId], references: [id], onDelete: Cascade)
  createdBy User?     @relation("CardEvidenceCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([cardAssetId, kind])
  @@index([createdById])
}

model CardPhoto {
  id           String        @id @default(uuid())
  cardAssetId  String
  kind         CardPhotoKind @default(FRONT)
  storageKey   String
  fileName     String
  fileSize     Int
  mimeType     String
  imageUrl     String
  thumbnailUrl String?
  backgroundRemovedAt DateTime?
  createdById  String?
  createdAt    DateTime      @default(now())

  cardAsset CardAsset @relation(fields: [cardAssetId], references: [id], onDelete: Cascade)
  createdBy User?     @relation("CardPhotoCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([cardAssetId, kind])
  @@index([createdById])
}

model CardNote {
  id        String   @id @default(uuid())
  cardId    String
  authorId  String
  body      String
  createdAt DateTime @default(now())

  card   CardAsset @relation(fields: [cardId], references: [id], onDelete: Cascade)
  author User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
}

model ProcessingJob {
  id           String              @id @default(uuid())
  cardAssetId  String
  type         ProcessingJobType
  status       ProcessingJobStatus @default(QUEUED)
  payload      Json?
  attempts     Int                 @default(0)
  errorMessage String?
  lockedAt     DateTime?
  completedAt  DateTime?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  cardAsset CardAsset @relation(fields: [cardAssetId], references: [id], onDelete: Cascade)
}

model BytebotLiteJob {
  id          String              @id @default(uuid())
  cardAssetId String?
  status      BytebotLiteJobStatus @default(QUEUED)
  searchQuery String
  sources     String[]
  maxComps    Int                 @default(5)
  maxAgeDays  Int                 @default(730)
  payload     Json?
  result      Json?
  errorMessage String?
  attempts    Int                 @default(0)
  lockedAt    DateTime?
  completedAt DateTime?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  cardAsset CardAsset? @relation(fields: [cardAssetId], references: [id], onDelete: SetNull)

  @@index([status, createdAt])
  @@index([cardAssetId])
}

model BytebotPlaybookRule {
  id          String   @id @default(uuid())
  source      String
  action      String
  selector    String
  urlContains String?
  label       String?
  priority    Int      @default(0)
  enabled     Boolean  @default(true)
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdBy User? @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@index([source, enabled, priority])
  @@index([createdById])
}

model SportsDbTeam {
  id             String    @id
  name           String
  alternateNames String[]  @default([])
  sport          String
  league         String?
  city           String?
  abbreviation   String?
  logoUrl        String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  lastSyncedAt   DateTime?

  players SportsDbPlayer[]

  @@index([sport, league])
  @@index([name])
}

model SportsDbPlayer {
  id             String    @id
  fullName       String
  displayName    String?
  alternateNames String[]  @default([])
  sport          String
  league         String?
  nationality    String?
  position       String?
  birthDate      DateTime?
  active         Boolean   @default(true)
  teamId         String?
  headshotUrl    String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  lastSyncedAt   DateTime?

  team       SportsDbTeam?          @relation(fields: [teamId], references: [id], onDelete: SetNull)
  seasons    SportsDbPlayerSeason[]
  cardAssets CardAsset[]

  @@index([sport, league])
  @@index([fullName])
  @@index([teamId])
}

model SportsDbPlayerSeason {
  id           String    @id @default(uuid())
  playerId     String
  season       String
  league       String?
  statsJson    Json
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastSyncedAt DateTime?

  player SportsDbPlayer @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, season, league])
  @@index([season])
}

model QrCode {
  id          String      @id @default(uuid())
  code        String      @unique
  serial      String?     @unique
  type        QrCodeType
  state       QrCodeState @default(AVAILABLE)
  payloadUrl  String?
  metadata    Json?
  locationId  String?
  createdById String?
  boundById   String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  boundAt     DateTime?
  retiredAt   DateTime?
  resetVersion Int        @default(0)

  location    Location?     @relation(fields: [locationId], references: [id], onDelete: SetNull)
  createdBy   User?         @relation("QrCodeCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  boundBy     User?         @relation("QrCodeBoundBy", fields: [boundById], references: [id], onDelete: SetNull)
  item        Item?         @relation("CardQrCode")
  packInstance PackInstance? @relation("PackQrCode")
  kioskSessions KioskSession[] @relation("SessionPackQr")
  packLabelCard PackLabel?   @relation("PackLabelCardQr")
  packLabelPack PackLabel?   @relation("PackLabelPackQr")
}

model PackLabel {
  id             String           @id @default(uuid())
  pairId         String           @unique
  cardQrCodeId   String           @unique
  packQrCodeId   String           @unique
  itemId         String?
  packInstanceId String?          @unique
  locationId     String?
  batchId        String?
  status         PackLabelStatus  @default(RESERVED)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  printedAt      DateTime?

  cardQrCode   QrCode        @relation("PackLabelCardQr", fields: [cardQrCodeId], references: [id], onDelete: Cascade)
  packQrCode   QrCode        @relation("PackLabelPackQr", fields: [packQrCodeId], references: [id], onDelete: Cascade)
  item         Item?         @relation(fields: [itemId], references: [id], onDelete: SetNull)
  packInstance PackInstance? @relation(fields: [packInstanceId], references: [id], onDelete: SetNull)
  location     Location?     @relation(fields: [locationId], references: [id], onDelete: SetNull)
  batch        CardBatch?    @relation(fields: [batchId], references: [id], onDelete: SetNull)

  @@index([locationId])
  @@index([batchId])
  @@index([status])
}
